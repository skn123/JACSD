PROGRAM SVALSERR
  USE, INTRINSIC :: ISO_FORTRAN_ENV, ONLY: OUTPUT_UNIT, ERROR_UNIT
  USE BIO
  IMPLICIT NONE
#include "qx_wp.fi"

  DOUBLE PRECISION, PARAMETER :: D_ZERO = 0.0D0
  REAL(KIND=WP), PARAMETER :: Q_ZERO = 0.0_WP, Q_ONE = 1.0_WP

  INTEGER, PARAMETER :: FNL = 252
  CHARACTER(LEN=2), PARAMETER :: ACT = 'RO'

  CHARACTER(LEN=FNL) :: FTRUE, FCOMP
  DOUBLE PRECISION :: MINAE, MAXAE, AVGAE, MINRE, MAXRE, AVGRE
  INTEGER :: N, INFO, U

  DOUBLE PRECISION, ALLOCATABLE :: T(:), C(:)

  CALL READCL(N, FTRUE, FCOMP, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'READCL'
  END IF

  ALLOCATE(T(N))
  ALLOCATE(C(N))

  WRITE (OUTPUT_UNIT,'(A)') '"Sx","MINAE","MAXAE","AVGAE","MINRE","MAXRE","AVGRE"'
  FLUSH(OUTPUT_UNIT)

  U = -1
  CALL BIO_OPEN(U, TRIM(FTRUE)//'.SY', ACT, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_OPEN(SYT)'
  END IF
  CALL BIO_READ_D1(U, N, T, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_READ_D1(SYT)'
  END IF
  CALL BIO_CLOSE(U, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_CLOSE(SYT)'
  END IF

  U = -1
  CALL BIO_OPEN(U, TRIM(FCOMP)//'.SY', ACT, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_OPEN(SYC)'
  END IF
  CALL BIO_READ_D1(U, N, C, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_READ_D1(SYC)'
  END IF
  CALL BIO_CLOSE(U, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_CLOSE(SYC)'
  END IF

  CALL ERRSTATS(N, T, C, MINAE, MAXAE, AVGAE, MINRE, MAXRE, AVGRE, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'ERRSTATS(SY)'
  END IF
  WRITE (OUTPUT_UNIT,'(A,6(A,ES24.17E3))') '"SY"', ',',MINAE,',',MAXAE,',',AVGAE,',',MINRE,',',MAXRE,',',AVGRE
  FLUSH(OUTPUT_UNIT)

  U = -1
  CALL BIO_OPEN(U, TRIM(FTRUE)//'.SW', ACT, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_OPEN(SWT)'
  END IF
  CALL BIO_READ_D1(U, N, T, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_READ_D1(SWT)'
  END IF
  CALL BIO_CLOSE(U, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_CLOSE(SWT)'
  END IF

  U = -1
  CALL BIO_OPEN(U, TRIM(FCOMP)//'.SW', ACT, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_OPEN(SWC)'
  END IF
  CALL BIO_READ_D1(U, N, C, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_READ_D1(SWC)'
  END IF
  CALL BIO_CLOSE(U, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_CLOSE(SWC)'
  END IF

  CALL ERRSTATS(N, T, C, MINAE, MAXAE, AVGAE, MINRE, MAXRE, AVGRE, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'ERRSTATS(SY)'
  END IF
  WRITE (OUTPUT_UNIT,'(A,6(A,ES24.17E3))') '"SW"', ',',MINAE,',',MAXAE,',',AVGAE,',',MINRE,',',MAXRE,',',AVGRE
  FLUSH(OUTPUT_UNIT)

  U = -1
  CALL BIO_OPEN(U, TRIM(FTRUE)//'.SS', ACT, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_OPEN(SST)'
  END IF
  CALL BIO_READ_D1(U, N, T, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_READ_D1(SST)'
  END IF
  CALL BIO_CLOSE(U, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_CLOSE(SST)'
  END IF

  U = -1
  CALL BIO_OPEN(U, TRIM(FCOMP)//'.SS', ACT, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_OPEN(SSC)'
  END IF
  CALL BIO_READ_D1(U, N, C, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_READ_D1(SSC)'
  END IF
  CALL BIO_CLOSE(U, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'BIO_CLOSE(SSC)'
  END IF

  CALL ERRSTATS(N, T, C, MINAE, MAXAE, AVGAE, MINRE, MAXRE, AVGRE, INFO)
  IF (INFO .NE. 0) THEN
     WRITE (ERROR_UNIT,'(I2,A)',ADVANCE='NO') INFO, ' '
     FLUSH(ERROR_UNIT)
     ERROR STOP 'ERRSTATS(SY)'
  END IF
  WRITE (OUTPUT_UNIT,'(A,6(A,ES24.17E3))') '"SS"', ',',MINAE,',',MAXAE,',',AVGAE,',',MINRE,',',MAXRE,',',AVGRE
  FLUSH(OUTPUT_UNIT)

  DEALLOCATE(C)
  DEALLOCATE(T)

CONTAINS

  PURE SUBROUTINE ERRSTATS(N, T, C, MINAE, MAXAE, AVGAE, MINRE, MAXRE, AVGRE, INFO)
    IMPLICIT NONE
    INTEGER, INTENT(IN) :: N
    DOUBLE PRECISION, INTENT(IN) :: T(N), C(N)
    DOUBLE PRECISION, INTENT(OUT) :: MINAE, MAXAE, AVGAE, MINRE, MAXRE, AVGRE
    INTEGER, INTENT(OUT) :: INFO

    REAL(KIND=WP) :: Q_MINAE, Q_MAXAE, Q_AVGAE, Q_MINRE, Q_MAXRE, Q_AVGRE
    REAL(KIND=WP) :: Q_AE, Q_RE, Q_ONE_N
    INTEGER :: I

    IF (N .LT. 0) THEN
       INFO = -1
    ELSE
       INFO = 0
    END IF
    IF (INFO .NE. 0) RETURN

    MINAE = D_ZERO
    MAXAE = D_ZERO
    AVGAE = D_ZERO

    MINRE = D_ZERO
    MAXRE = D_ZERO
    AVGRE = D_ZERO

    IF (N .EQ. 0) RETURN

    Q_MINAE = Q_ZERO
    Q_MAXAE = Q_ZERO
    Q_AVGAE = Q_ZERO

    Q_MINRE = Q_ZERO
    Q_MAXRE = Q_ZERO
    Q_AVGRE = Q_ZERO

    Q_ONE_N = Q_ONE / N

    DO I = 1, N
       Q_AE = ABS(REAL(T(I), WP) - REAL(C(I), WP))
       IF (Q_AE .LT. Q_MINAE) Q_MINAE = Q_AE
       IF (Q_AE .GT. Q_MAXAE) Q_MAXAE = Q_AE
       Q_AVGAE = Q_AVGAE + Q_AE * Q_ONE_N

       Q_RE = Q_AE / ABS(REAL(T(I), WP))
       IF (.NOT. (Q_RE .EQ. Q_RE)) Q_RE = Q_ZERO
       IF (Q_RE .LT. Q_MINRE) Q_MINRE = Q_RE
       IF (Q_RE .GT. Q_MAXRE) Q_MAXRE = Q_RE
       Q_AVGRE = Q_AVGRE + Q_RE * Q_ONE_N
    END DO

    MINAE = DBLE(Q_MINAE)
    MAXAE = DBLE(Q_MAXAE)
    AVGAE = DBLE(Q_AVGAE)

    MINRE = DBLE(Q_MINRE)
    MAXRE = DBLE(Q_MAXRE)
    AVGRE = DBLE(Q_AVGRE)
  END SUBROUTINE ERRSTATS

  SUBROUTINE READCL(N, FTRUE, FCOMP, INFO)
    IMPLICIT NONE
    INTEGER, INTENT(OUT) :: N, INFO
    CHARACTER(LEN=*), INTENT(OUT) :: FTRUE, FCOMP

    CHARACTER(LEN=FNL) :: ARG
    INTEGER :: TMP

    INFO = 0
    IF (COMMAND_ARGUMENT_COUNT() .NE. 3) ERROR STOP 'svalerr.exe N FTRUE FCOMP'

    CALL GET_COMMAND_ARGUMENT(1, ARG, TMP, INFO)
    IF (INFO .NE. 0) THEN
       INFO = -1
       RETURN
    END IF
    READ (ARG,*) N
    IF (N .LE. 0) THEN
       INFO = 1
       RETURN
    END IF

    CALL GET_COMMAND_ARGUMENT(2, ARG, TMP, INFO)
    IF (INFO .NE. 0) THEN
       INFO = -2
       RETURN
    END IF
    FTRUE = TRIM(ARG)
    IF (LEN_TRIM(FTRUE) .LE. 0) THEN
       INFO = 2
       RETURN
    END IF

    CALL GET_COMMAND_ARGUMENT(3, ARG, TMP, INFO)
    IF (INFO .NE. 0) THEN
       INFO = -3
       RETURN
    END IF
    FCOMP = TRIM(ARG)
    IF (LEN_TRIM(FCOMP) .LE. 0) THEN
       INFO = 3
       RETURN
    END IF
  END SUBROUTINE READCL

END PROGRAM SVALSERR
